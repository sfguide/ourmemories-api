<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Moment</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:#f6f6f6}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px;background:#fff;border-bottom:1px solid #e6e6e6}
    .btn{border:1px solid #ccc;border-radius:10px;padding:10px 12px;background:#fff}
    .wrap{padding:14px}
    textarea,input{width:100%;border:1px solid #ddd;border-radius:12px;padding:10px;font-size:14px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin-top:12px}
    .lbl{font-weight:800;margin-bottom:8px}
    .row{display:flex;gap:10px;overflow-x:auto;padding-top:10px}
    .thumb{width:120px;height:90px;border-radius:12px;object-fit:cover;border:1px solid #eee}
    .msg{margin-top:10px;opacity:.8}
  </style>
</head>
<body>
  <header>
    <button class="btn" onclick="history.back()">Back</button>
    <div style="font-weight:900">Add Moment</div>
    <button class="btn" id="save">Save</button>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="lbl">Location (optional)</div>
      <input id="location" placeholder="e.g., Siesta Key Beach" />
    </div>

    <div class="card">
      <div class="lbl">Story</div>
      <textarea id="story" rows="5" placeholder="Write a quick memory…"></textarea>
    </div>

    <div class="card">
      <div class="lbl">Photos / Videos</div>
      <input id="mediaInput" type="file" accept="image/*,video/*" multiple />
      <div id="mediaPreview" class="row"></div>
    </div>

    <div class="card">
      <div class="lbl">Attachments (PDF, audio, etc.)</div>
      <input id="attachInput" type="file" multiple />
      <div id="attachList" class="msg"></div>
    </div>

    <div id="msg" class="msg"></div>
  </div>

  <script>
    const tripId = new URLSearchParams(location.search).get("tripId");
    const API_BASE = "https://ourmemories-api.render.com";
    const mediaInput = document.getElementById("mediaInput");
    const attachInput = document.getElementById("attachInput");
    const mediaPreview = document.getElementById("mediaPreview");
    const attachList = document.getElementById("attachList");
    const msg = document.getElementById("msg");

    function emailHeader(){
      const email = (localStorage.getItem("om_email")||"").trim();
      if(!email) throw new Error("Set email on Trips page first.");
      return email;
    }

  async function uploadViaApi(file, kind) {
      const url = `${API_BASE}/api/uploads/proxy`;
      console.log("uploadViaApi → POST", url, "kind=", kind, "file=", file.name);
    
      const fd = new FormData();
      fd.append("tripId", tripId);
      fd.append("kind", kind);
      fd.append("file", file);
    
      const res = await fetch(url, {
        method: "POST",
        headers: { "X-User-Email": emailHeader() },
        body: fd
      });

      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    function previewMedia(files){
      mediaPreview.innerHTML = "";
      [...files].slice(0,12).forEach(f=>{
        const img = document.createElement("img");
        img.className = "thumb";
        img.src = URL.createObjectURL(f);
        mediaPreview.appendChild(img);
      });
    }

    function listAttach(files){
      attachList.textContent = [...files].map(f => "• " + f.name).join("\n");
    }

    mediaInput.addEventListener("change", e => previewMedia(e.target.files));
    attachInput.addEventListener("change", e => listAttach(e.target.files));

    async function apiJSON(path, opts = {}) {
      const headers = Object.assign({}, opts.headers || {}, { "X-User-Email": emailHeader() });
      const url = /^https?:\/\//i.test(path) ? path : `${API_BASE}${path}`;
    
      console.log("apiJSON →", opts.method || "GET", url);
    
      const res = await fetch(url, { ...opts, headers });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    document.getElementById("save").onclick = async () => {
      const story = document.getElementById("story").value.trim();
      const locationName = document.getElementById("location").value.trim();
      const mediaFiles = [...mediaInput.files];
      const attachFiles = [...attachInput.files];

      try{
        msg.textContent = "Saving moment…";

        // 1) Create moment in DB first
        const moment = await apiJSON(`/api/trips/${tripId}/moments`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ story, locationName })
        });
        const momentId = moment.id;

        // 2) Upload + commit media (via API proxy upload)
        for (const f of mediaFiles) {
          msg.textContent = `Uploading media: ${f.name}`;
        
          const meta = await uploadViaApi(f, "media"); // <-- NEW
        
          const type = (f.type || "").startsWith("video/") ? "video" : "photo";
          await apiJSON("/api/media/commit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tripId,
              momentId,
              type,
              storageKey: meta.storageKey,
              cdnUrl: meta.cdnUrl,
              sizeBytes: meta.sizeBytes ?? f.size
            })
          });
        }      

       // 3) Upload + commit attachments (via API proxy upload)
      for (const f of attachFiles) {
        msg.textContent = `Uploading attachment: ${f.name}`;
      
        const meta = await uploadViaApi(f, "attachment");
      
        let aType = "other";
        if (f.type === "application/pdf") aType = "pdf";
        else if ((f.type || "").startsWith("audio/")) aType = "audio";
        // NOTE: keep images/videos in Media; attachments are for PDFs/audio/docs/etc.
        // If you *do* want images as attachments, we can allow that later.
      
        await apiJSON("/api/attachments/commit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tripId,
            momentId,
            type: aType,
            title: f.name,
            storageKey: meta.storageKey,
            cdnUrl: meta.cdnUrl,
            sizeBytes: meta.sizeBytes ?? f.size
          })
        });
      }

        msg.textContent = "Done!";
        location.href = `/ui/trip?tripId=${encodeURIComponent(tripId)}`;
      }catch(e){
        msg.textContent = e.message;
        console.error(e);
      }
    };
  </script>
</body>
</html>
